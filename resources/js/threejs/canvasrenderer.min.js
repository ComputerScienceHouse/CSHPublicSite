/**
 * @author mrdoob / http://mrdoob.com/
 */
THREE.SpriteCanvasMaterial=function(e){THREE.Material.call(this),this.type="SpriteCanvasMaterial",this.color=new THREE.Color(16777215),this.program=function(e,t){},this.setValues(e)},THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype),THREE.SpriteCanvasMaterial.prototype.constructor=THREE.SpriteCanvasMaterial,THREE.SpriteCanvasMaterial.prototype.clone=function(){var e=new THREE.SpriteCanvasMaterial;return e.copy(this),e.color.copy(this.color),e.program=this.program,e},THREE.CanvasRenderer=function(e){function t(){xe.setRGB(0,0,0),ye.setRGB(0,0,0),ue.setRGB(0,0,0);for(var e=0,t=T.length;t>e;e++){var i=T[e],n=i.color;i instanceof THREE.AmbientLight?xe.add(n):i instanceof THREE.DirectionalLight?ye.add(n):i instanceof THREE.PointLight&&ue.add(n)}}function i(e,t,i){for(var n=0,o=T.length;o>n;n++){var r=T[n];if(fe.copy(r.color),r instanceof THREE.DirectionalLight){var a=Re.setFromMatrixPosition(r.matrixWorld).normalize(),s=t.dot(a);if(0>=s)continue;s*=r.intensity,i.add(fe.multiplyScalar(s))}else if(r instanceof THREE.PointLight){var a=Re.setFromMatrixPosition(r.matrixWorld),s=t.dot(Re.subVectors(a,e).normalize());if(0>=s)continue;if(s*=0==r.distance?1:1-Math.min(e.distanceTo(a)/r.distance,1),0==s)continue;s*=r.intensity,i.add(fe.multiplyScalar(s))}}}function n(e,t,i){f(i.opacity),d(i.blending);var n=t.scale.x*q,o=t.scale.y*J,r=.5*Math.sqrt(n*n+o*o);if(ve.min.set(e.x-r,e.y-r),ve.max.set(e.x+r,e.y+r),i instanceof THREE.SpriteMaterial){var a=i.map;if(null!==a){var s=de[a.id];if((void 0===s||s.version!==a.version)&&(s=c(a),de[a.id]=s),void 0!==s.canvas){y(s.canvas);var l=a.image,p=l.width*a.offset.x,E=l.height*a.offset.y,h=l.width*a.repeat.x,m=l.height*a.repeat.y,v=n/h,u=o/m;$.save(),$.translate(e.x,e.y),0!==i.rotation&&$.rotate(i.rotation),$.translate(-n/2,-o/2),$.scale(v,u),$.translate(-p,-E),$.fillRect(p,E,h,m),$.restore()}}else y(i.color.getStyle()),$.save(),$.translate(e.x,e.y),0!==i.rotation&&$.rotate(i.rotation),$.scale(n,-o),$.fillRect(-.5,-.5,1,1),$.restore()}else i instanceof THREE.SpriteCanvasMaterial&&(x(i.color.getStyle()),y(i.color.getStyle()),$.save(),$.translate(e.x,e.y),0!==i.rotation&&$.rotate(i.rotation),$.scale(n,o),i.program($),$.restore())}function o(e,t,i,n){if(f(n.opacity),d(n.blending),$.beginPath(),$.moveTo(e.positionScreen.x,e.positionScreen.y),$.lineTo(t.positionScreen.x,t.positionScreen.y),n instanceof THREE.LineBasicMaterial){if(h(n.linewidth),m(n.linecap),v(n.linejoin),n.vertexColors!==THREE.VertexColors)x(n.color.getStyle());else{var o=i.vertexColors[0].getStyle(),r=i.vertexColors[1].getStyle();if(o===r)x(o);else{try{var a=$.createLinearGradient(e.positionScreen.x,e.positionScreen.y,t.positionScreen.x,t.positionScreen.y);a.addColorStop(0,o),a.addColorStop(1,r)}catch(s){a=o}x(a)}}$.stroke(),ve.expandByScalar(2*n.linewidth)}else n instanceof THREE.LineDashedMaterial&&(h(n.linewidth),m(n.linecap),v(n.linejoin),x(n.color.getStyle()),u([n.dashSize,n.gapSize]),$.stroke(),ve.expandByScalar(2*n.linewidth),u([]))}function r(e,t,n,o,r,c,E,h){if(A.info.render.vertices+=3,A.info.render.faces++,f(h.opacity),d(h.blending),M=e.positionScreen.x,b=e.positionScreen.y,L=t.positionScreen.x,B=t.positionScreen.y,P=n.positionScreen.x,V=n.positionScreen.y,a(M,b,L,B,P,V),(h instanceof THREE.MeshLambertMaterial||h instanceof THREE.MeshPhongMaterial)&&null===h.map)pe.copy(h.color),Ee.copy(h.emissive),h.vertexColors===THREE.FaceColors&&pe.multiply(E.color),ce.copy(xe),Se.copy(e.positionWorld).add(t.positionWorld).add(n.positionWorld).divideScalar(3),i(Se,E.normalModel,ce),ce.multiply(pe).add(Ee),h.wireframe===!0?s(ce,h.wireframeLinewidth,h.wireframeLinecap,h.wireframeLinejoin):l(ce);else if(h instanceof THREE.MeshBasicMaterial||h instanceof THREE.MeshLambertMaterial||h instanceof THREE.MeshPhongMaterial)if(null!==h.map){var m=h.map.mapping;m===THREE.UVMapping&&(z=E.uvs,p(M,b,L,B,P,V,z[o].x,z[o].y,z[r].x,z[r].y,z[c].x,z[c].y,h.map))}else null!==h.envMap?h.envMap.mapping===THREE.SphericalReflectionMapping&&(Te.copy(E.vertexNormalsModel[o]).applyMatrix3(ge),j=.5*Te.x+.5,W=.5*Te.y+.5,Te.copy(E.vertexNormalsModel[r]).applyMatrix3(ge),D=.5*Te.x+.5,F=.5*Te.y+.5,Te.copy(E.vertexNormalsModel[c]).applyMatrix3(ge),N=.5*Te.x+.5,k=.5*Te.y+.5,p(M,b,L,B,P,V,j,W,D,F,N,k,h.envMap)):(ce.copy(h.color),h.vertexColors===THREE.FaceColors&&ce.multiply(E.color),h.wireframe===!0?s(ce,h.wireframeLinewidth,h.wireframeLinecap,h.wireframeLinejoin):l(ce));else h instanceof THREE.MeshNormalMaterial?(Te.copy(E.normalModel).applyMatrix3(ge),ce.setRGB(Te.x,Te.y,Te.z).multiplyScalar(.5).addScalar(.5),h.wireframe===!0?s(ce,h.wireframeLinewidth,h.wireframeLinecap,h.wireframeLinejoin):l(ce)):(ce.setRGB(1,1,1),h.wireframe===!0?s(ce,h.wireframeLinewidth,h.wireframeLinecap,h.wireframeLinejoin):l(ce))}function a(e,t,i,n,o,r){$.beginPath(),$.moveTo(e,t),$.lineTo(i,n),$.lineTo(o,r),$.closePath()}function s(e,t,i,n){h(t),m(i),v(n),x(e.getStyle()),$.stroke(),ve.expandByScalar(2*t)}function l(e){y(e.getStyle()),$.fill()}function c(e){if(0===e.version||e instanceof THREE.CompressedTexture||e instanceof THREE.DataTexture)return{canvas:void 0,version:e.version};var t=e.image;if(t.complete===!1)return{canvas:void 0,version:0};var i=document.createElement("canvas");i.width=t.width,i.height=t.height;var n=i.getContext("2d");n.setTransform(1,0,0,-1,0,t.height),n.drawImage(t,0,0);var o=e.wrapS===THREE.RepeatWrapping,r=e.wrapT===THREE.RepeatWrapping,a="no-repeat";o===!0&&r===!0?a="repeat":o===!0?a="repeat-x":r===!0&&(a="repeat-y");var s=$.createPattern(i,a);return e.onUpdate&&e.onUpdate(e),{canvas:s,version:e.version}}function p(e,t,i,n,o,r,a,s,l,p,E,f,d){var h=de[d.id];if((void 0===h||h.version!==d.version)&&(h=c(d),de[d.id]=h),void 0===h.canvas)return y("rgba( 0, 0, 0, 1)"),void $.fill();y(h.canvas);var m,v,x,u,R,S,T,g,H=d.offset.x/d.repeat.x,w=d.offset.y/d.repeat.y,C=d.image.width*d.repeat.x,M=d.image.height*d.repeat.y;a=(a+H)*C,s=(s+w)*M,l=(l+H)*C,p=(p+w)*M,E=(E+H)*C,f=(f+w)*M,i-=e,n-=t,o-=e,r-=t,l-=a,p-=s,E-=a,f-=s,T=l*f-E*p,0!==T&&(g=1/T,m=(f*i-p*o)*g,v=(f*n-p*r)*g,x=(l*o-E*i)*g,u=(l*r-E*n)*g,R=e-m*a-x*s,S=t-v*a-u*s,$.save(),$.transform(m,v,x,u,R,S),$.fill(),$.restore())}function E(e,t,i){var n,o=t.x-e.x,r=t.y-e.y,a=o*o+r*r;0!==a&&(n=i/Math.sqrt(a),o*=n,r*=n,t.x+=o,t.y+=r,e.x-=o,e.y-=r)}function f(e){te!==e&&($.globalAlpha=e,te=e)}function d(e){ie!==e&&(e===THREE.NormalBlending?$.globalCompositeOperation="source-over":e===THREE.AdditiveBlending?$.globalCompositeOperation="lighter":e===THREE.SubtractiveBlending&&($.globalCompositeOperation="darker"),ie=e)}function h(e){re!==e&&($.lineWidth=e,re=e)}function m(e){ae!==e&&($.lineCap=e,ae=e)}function v(e){se!==e&&($.lineJoin=e,se=e)}function x(e){ne!==e&&($.strokeStyle=e,ne=e)}function y(e){oe!==e&&($.fillStyle=e,oe=e)}function u(e){le.length!==e.length&&($.setLineDash(e),le=e)}console.log("THREE.CanvasRenderer",THREE.REVISION),e=e||{};var R,S,T,g,H,w,C,M,b,L,B,P,V,z,j,W,D,F,N,k,A=this,O=new THREE.Projector,G=void 0!==e.canvas?e.canvas:document.createElement("canvas"),I=G.width,U=G.height,q=Math.floor(I/2),J=Math.floor(U/2),K=0,Q=0,X=I,Y=U,Z=1,$=G.getContext("2d",{alpha:e.alpha===!0}),_=new THREE.Color(0),ee=e.alpha===!0?0:1,te=1,ie=0,ne=null,oe=null,re=null,ae=null,se=null,le=[],ce=(new THREE.RenderableVertex,new THREE.RenderableVertex,new THREE.Color),pe=(new THREE.Color,new THREE.Color,new THREE.Color,new THREE.Color,new THREE.Color),Ee=new THREE.Color,fe=new THREE.Color,de={},he=new THREE.Box2,me=new THREE.Box2,ve=new THREE.Box2,xe=new THREE.Color,ye=new THREE.Color,ue=new THREE.Color,Re=new THREE.Vector3,Se=new THREE.Vector3,Te=new THREE.Vector3,ge=new THREE.Matrix3;void 0===$.setLineDash&&($.setLineDash=function(){}),this.domElement=G,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.getContext=function(){return $},this.getContextAttributes=function(){return $.getContextAttributes()},this.getPixelRatio=function(){return Z},this.setPixelRatio=function(e){void 0!==e&&(Z=e)},this.setSize=function(e,t,i){I=e*Z,U=t*Z,G.width=I,G.height=U,q=Math.floor(I/2),J=Math.floor(U/2),i!==!1&&(G.style.width=e+"px",G.style.height=t+"px"),he.min.set(-q,-J),he.max.set(q,J),me.min.set(-q,-J),me.max.set(q,J),te=1,ie=0,ne=null,oe=null,re=null,ae=null,se=null,this.setViewport(0,0,e,t)},this.setViewport=function(e,t,i,n){K=e*Z,Q=t*Z,X=i*Z,Y=n*Z},this.setScissor=function(){},this.setScissorTest=function(){},this.setClearColor=function(e,t){_.set(e),ee=void 0!==t?t:1,me.min.set(-q,-J),me.max.set(q,J)},this.setClearColorHex=function(e,t){console.warn("THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead."),this.setClearColor(e,t)},this.getClearColor=function(){return _},this.getClearAlpha=function(){return ee},this.getMaxAnisotropy=function(){return 0},this.clear=function(){me.isEmpty()===!1&&(me.intersect(he),me.expandByScalar(2),me.min.x=me.min.x+q,me.min.y=-me.min.y+J,me.max.x=me.max.x+q,me.max.y=-me.max.y+J,1>ee&&$.clearRect(0|me.min.x,0|me.max.y,me.max.x-me.min.x|0,me.min.y-me.max.y|0),ee>0&&(d(THREE.NormalBlending),f(1),y("rgba("+Math.floor(255*_.r)+","+Math.floor(255*_.g)+","+Math.floor(255*_.b)+","+ee+")"),$.fillRect(0|me.min.x,0|me.max.y,me.max.x-me.min.x|0,me.min.y-me.max.y|0)),me.makeEmpty())},this.clearColor=function(){},this.clearDepth=function(){},this.clearStencil=function(){},this.render=function(e,i){if(i instanceof THREE.Camera==!1)return void console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");this.autoClear===!0&&this.clear(),A.info.render.vertices=0,A.info.render.faces=0,$.setTransform(X/I,0,0,-Y/U,K,U-Q),$.translate(q,J),R=O.projectScene(e,i,this.sortObjects,this.sortElements),S=R.elements,T=R.lights,g=i,ge.getNormalMatrix(i.matrixWorldInverse),t();for(var a=0,s=S.length;s>a;a++){var l=S[a],c=l.material;if(void 0!==c&&0!==c.opacity){if(ve.makeEmpty(),l instanceof THREE.RenderableSprite)H=l,H.x*=q,H.y*=J,n(H,l,c);else if(l instanceof THREE.RenderableLine)H=l.v1,w=l.v2,H.positionScreen.x*=q,H.positionScreen.y*=J,w.positionScreen.x*=q,w.positionScreen.y*=J,ve.setFromPoints([H.positionScreen,w.positionScreen]),he.intersectsBox(ve)===!0&&o(H,w,l,c);else if(l instanceof THREE.RenderableFace){if(H=l.v1,w=l.v2,C=l.v3,H.positionScreen.z<-1||H.positionScreen.z>1)continue;if(w.positionScreen.z<-1||w.positionScreen.z>1)continue;if(C.positionScreen.z<-1||C.positionScreen.z>1)continue;H.positionScreen.x*=q,H.positionScreen.y*=J,w.positionScreen.x*=q,w.positionScreen.y*=J,C.positionScreen.x*=q,C.positionScreen.y*=J,c.overdraw>0&&(E(H.positionScreen,w.positionScreen,c.overdraw),E(w.positionScreen,C.positionScreen,c.overdraw),E(C.positionScreen,H.positionScreen,c.overdraw)),ve.setFromPoints([H.positionScreen,w.positionScreen,C.positionScreen]),he.intersectsBox(ve)===!0&&r(H,w,C,0,1,2,l,c)}me.union(ve)}}$.setTransform(1,0,0,1,0,0)}};